<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªØ·ÙˆØ±Ø© â€“ Ø§Ù„Ù…Ù†ÙŠÙˆ</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
    background:#000;
    color:#fff;
    font-family:"Cairo", sans-serif;
    padding:20px;
}

h1{
    color:#c9a45a;
    text-align:center;
    margin-bottom:25px;
}

.box{
    background:#111;
    padding:20px;
    border-radius:12px;
    margin-bottom:20px;
    border:1px solid #333;
}

input, select{
    width:100%;
    padding:10px;
    margin-top:8px;
    border-radius:8px;
    border:1px solid #444;
    background:#000;
    color:#fff;
}

button{
    padding:10px 15px;
    border:none;
    border-radius:8px;
    background:#c9a45a;
    font-weight:bold;
    cursor:pointer;
    margin-top:10px;
}

.row{
    display:flex;
    gap:15px;
}

.product{
    background:#1b1b1b;
    padding:12px;
    border-radius:10px;
    margin-top:12px;
    border:1px solid #333;
}

.product img{
    width:100px;
    border-radius:6px;
    cursor:pointer;
}

.btn{
    padding:6px 10px;
    border-radius:6px;
    font-size:13px;
    cursor:pointer;
}

.edit{ background:#0077ff; color:#fff; }
.del{ background:#b30000; color:#fff; }

/* Popup for image preview */
#imgPreviewPopup{
    position:fixed;
    top:0;left:0;
    width:100%;height:100%;
    background:rgba(0,0,0,.85);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
}
#imgPreviewPopup img{
    width:80%;
    border-radius:10px;
}

</style>
</head>

<body>

<h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªØ·ÙˆØ±Ø© â€“ Ø§Ù„Ù…Ù†ÙŠÙˆ</h1>

<!-- ======================== Ø§Ù„Ø¨Ø­Ø« ======================== -->
<div class="box">
    <h2>ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬</h2>
    <input id="searchBox" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬...">
    <div id="searchResults"></div>
</div>

<!-- ======================== Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ======================== -->
<div class="box">
    <h2>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>

    <div class="row">
        <input id="catName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…">
        <button onclick="addCategory()">â• Ø¥Ø¶Ø§ÙØ©</button>
    </div>

    <div id="catList"></div>
</div>

<!-- ======================== Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬ ======================== -->
<div class="box">
    <h2>ğŸ” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>

    <select id="catSelect"></select>

    <input id="prodName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
    <input id="prodPrice" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±">

    <label style="color:#aaa">Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)</label>
    <input type="file" id="prodImg" accept="image/*">
    <img id="preview" style="max-width:150px;margin-top:10px;display:none;border-radius:6px;">

    <button onclick="saveProduct()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
</div>

<!-- ======================== Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ======================== -->
<div class="box">
    <h2>ğŸ“¦ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
    <div id="productsList"></div>
</div>

<!-- ================== Image popup ================== -->
<div id="imgPreviewPopup" onclick="this.style.display='none'">
    <img src="">
</div>

<script>

/* ======================== Supabase ======================== */

const sb = supabase.createClient(
 "https://ztwbgqkxmdhpzqhnefty.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0d2JncWt4bWRocHpxaG5lZnR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMTQwMDEsImV4cCI6MjA3OTU5MDAwMX0.6W_V9v5VxQpPfv65Ygc51-m7G1Z8sl8fx1B8bWyA6Xg"
);

let editID = null;


/* ======================== ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ ======================== */
loadCategories();
loadProducts();


/* ======================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ======================== */
async function loadCategories(){
    const {data} = await sb.from("categories").select("*").order("id",{ascending:false});

    const catList = document.getElementById("catList");
    const catSelect = document.getElementById("catSelect");

    catList.innerHTML="";
    catSelect.innerHTML="<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>";

    data.forEach(c=>{
        catSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;

        catList.innerHTML += `
            <div class="product">
                <strong>${c.name}</strong>
                <button class="btn edit" onclick="editCategory(${c.id}, '${c.name}')">ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn del" onclick="deleteCategory(${c.id})">Ø­Ø°Ù</button>
            </div>
        `;
    });
}


/* ======================== Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… ======================== */
async function addCategory(){
    const name=document.getElementById("catName").value.trim();
    if(!name) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…");

    await sb.from("categories").insert([{name}]);
    document.getElementById("catName").value="";
    loadCategories();
}


/* ======================== ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… ======================== */
async function editCategory(id, oldName){
    const newName=prompt("Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯:", oldName);
    if(!newName) return;

    await sb.from("categories").update({name:newName}).eq("id",id);
    loadCategories();
}


/* ======================== Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… ======================== */
async function deleteCategory(id){
    if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… ÙˆØ¬Ù…ÙŠØ¹ Ù…Ù†ØªØ¬Ø§ØªÙ‡ØŸ")) return;

    await sb.from("products").delete().eq("category",id);
    await sb.from("categories").delete().eq("id",id);

    loadCategories();
    loadProducts();
}


/* ======================== Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ======================== */
async function uploadImg(file){
    let name = Date.now()+"-"+file.name;
    let {data,error} = await sb.storage.from("menu-images").upload(name,file);
    if(error) return null;
    return sb.storage.from("menu-images").getPublicUrl(name).data.publicUrl;
}


/* ======================== Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬ ======================== */
async function saveProduct(){
    const name=document.getElementById("prodName").value.trim();
    const price=Number(document.getElementById("prodPrice").value);
    const cat=document.getElementById("catSelect").value;
    const file=document.getElementById("prodImg").files[0];

    if(!name || !price || !cat)
        return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

    let imgURL=null;
    if(file){ imgURL = await uploadImg(file); }

    if(editID){  // ØªØ­Ø¯ÙŠØ«
        let payload = { name, price, category:cat };
        if(imgURL) payload.image=imgURL;

        await sb.from("products").update(payload).eq("id",editID);

        editID=null;
        alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
    }else{       // Ø¥Ø¶Ø§ÙØ©
        if(!imgURL) return alert("ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©");

        await sb.from("products").insert([{name,price,image:imgURL,category:cat}]);
        alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
    }

    resetForm();
    loadProducts();
}


/* ======================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ======================== */
async function loadProducts(){
    const {data} = await sb.from("products").select("*").order("id",{ascending:false});
    const list=document.getElementById("productsList");
    list.innerHTML="";

    data.forEach(p=>{
        list.innerHTML += `
            <div class="product">
                <strong>${p.name}</strong> â€” ${p.price} Ø±.Ø³
                <br>
                <img src="${p.image}" onclick="showImg('${p.image}')">
                <br>
                <button class="btn edit" onclick='startEdit(${p.id},"${p.name}",${p.price},${p.category},"${p.image}")'>ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn del" onclick="deleteProduct(${p.id})">Ø­Ø°Ù</button>
            </div>
        `;
    });
}


/* ======================== Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© ======================== */
function showImg(src){
    const popup=document.getElementById("imgPreviewPopup");
    popup.querySelector("img").src=src;
    popup.style.display="flex";
}


/* ======================== Ø¨Ø¯Ø¡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ ======================== */
function startEdit(id,name,price,cat,img){
    editID=id;
    document.getElementById("prodName").value=name;
    document.getElementById("prodPrice").value=price;
    document.getElementById("catSelect").value=cat;
    document.getElementById("preview").src=img;
    document.getElementById("preview").style.display="block";
}


/* ======================== Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ ======================== */
async function deleteProduct(id){
    if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) return;
    await sb.from("products").delete().eq("id",id);
    loadProducts();
}


/* ======================== Ø¨Ø­Ø« ======================== */
document.getElementById("searchBox").oninput=async()=>{
    const q=document.getElementById("searchBox").value.trim();
    const box=document.getElementById("searchResults");

    if(q.length < 2){ box.innerHTML=""; return; }

    const {data}=await sb.from("products")
        .select("*")
        .ilike("name", `%${q}%`);

    box.innerHTML="";

    data.forEach(p=>{
        box.innerHTML += `
            <div class="product">
                <strong>${p.name}</strong> â€” ${p.price} Ø±.Ø³
                <br>
                <img src="${p.image}">
                <br>
                <button class="btn edit" onclick='startEdit(${p.id},"${p.name}",${p.price},${p.category},"${p.image}")'>ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn del" onclick="deleteProduct(${p.id})">Ø­Ø°Ù</button>
            </div>
        `;
    });
};


/* ======================== Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ======================== */
function resetForm(){
    document.getElementById("prodName").value="";
    document.getElementById("prodPrice").value="";
    document.getElementById("catSelect").value="";
    document.getElementById("prodImg").value="";
    document.getElementById("preview").style.display="none";
}

</script>

</body>
</html>