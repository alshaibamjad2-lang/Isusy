<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>لوحة التحكم - إدارة المنتجات</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
    font-family:Tahoma, sans-serif;
    background:#111;
    color:#fff;
    margin:0;
    padding:20px;
}
h1{
    text-align:center;
    color:#c9a45a;
}
.panel{
    background:#181818;
    padding:20px;
    border-radius:12px;
    margin-bottom:20px;
    border:1px solid #333;
}
input, select{
    width:100%;
    padding:10px;
    margin:6px 0;
    border-radius:8px;
    border:none;
    background:#222;
    color:#fff;
}
button{
    background:#c9a45a;
    color:#000;
    padding:10px 16px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:bold;
}
button:hover{
    opacity:0.85;
}
.table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
}
.table th, .table td{
    border-bottom:1px solid #333;
    padding:10px;
}
.table img{
    width:70px;
    height:70px;
    object-fit:cover;
    border-radius:8px;
}
.actions button{
    margin:3px 0;
    width:100%;
}
.search{
    padding:12px;
    background:#222;
    border-radius:10px;
    width:100%;
}
</style>
</head>

<body>

<h1>لوحة التحكم - إدارة المنتجات</h1>

<div class="panel">
    <h3>إضافة / تعديل منتج</h3>

    <input type="hidden" id="editID">

    <label>اسم المنتج:</label>
    <input id="pName" type="text">

    <label>السعر:</label>
    <input id="pPrice" type="number">

    <label>القسم:</label>
    <select id="pCategory"></select>

    <label>الصورة:</label>
    <input id="pImage" type="file" accept="image/*">

    <button id="saveProduct">حفظ المنتج</button>
</div>

<div class="panel">
    <h3>بحث</h3>
    <input id="searchBox" class="search" type="text" placeholder="ابحث عن منتج...">
</div>

<div class="panel">
    <h3>المنتجات</h3>
    <table class="table" id="productsTable">
        <thead>
            <tr>
                <th>صورة</th>
                <th>الاسم</th>
                <th>السعر</th>
                <th>القسم</th>
                <th>تحكم</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="panel">
    <h3>الأقسام</h3>

    <input id="catName" type="text" placeholder="اسم القسم الجديد">
    <button id="addCategory">إضافة قسم</button>

    <table class="table" id="categoriesTable">
        <thead>
            <tr>
                <th>القسم</th>
                <th>تحكم</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>


<script>
/* ========= إعداد Supabase ========= */
const SUPABASE_URL = "https://ztwbgqkxmdhpzqhnefty.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6Ik...";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ========= تحميل الأقسام ========= */
async function loadCategories() {
    const { data } = await sb.from("categories").select("*").order("id");

    const sel = document.getElementById("pCategory");
    sel.innerHTML = "";

    data.forEach(c => {
        sel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
    });

    // تعبئة جدول الأقسام
    const tbody = document.querySelector("#categoriesTable tbody");
    tbody.innerHTML = "";

    data.forEach(c => {
        tbody.innerHTML += `
            <tr>
                <td>${c.name}</td>
                <td>
                    <button onclick="deleteCategory(${c.id})">حذف</button>
                </td>
            </tr>
        `;
    });
}

/* ========= حذف قسم ========= */
async function deleteCategory(id){
    if(!confirm("حذف القسم؟")) return;
    await sb.from("categories").delete().eq("id", id);
    loadCategories();
}

/* ========= تحميل المنتجات ========= */
async function loadProducts() {
    const { data } = await sb.from("products").select("*").order("id");

    renderProducts(data);

    // البحث
    document.getElementById("searchBox").oninput = (e)=>{
        const q = e.target.value.toLowerCase();
        const filtered = data.filter(p => p.name.toLowerCase().includes(q));
        renderProducts(filtered);
    };
}

function renderProducts(list){
    const tbody = document.querySelector("#productsTable tbody");
    tbody.innerHTML = "";

    list.forEach(p=>{
        tbody.innerHTML += `
            <tr>
                <td><img src="${p.image}" /></td>
                <td>${p.name}</td>
                <td>${p.price} ر.س</td>
                <td>${p.category}</td>
                <td class="actions">
                    <button onclick='editProduct(${JSON.stringify(p)})'>تعديل</button>
                    <button onclick='deleteProduct(${p.id})'>حذف</button>
                </td>
            </tr>
        `;
    });
}

/* ========= تعبئة النموذج عند التعديل ========= */
function editProduct(p){
    document.getElementById("editID").value = p.id;
    document.getElementById("pName").value = p.name;
    document.getElementById("pPrice").value = p.price;
    document.getElementById("pCategory").value = p.category;
    document.getElementById("pImage").value = "";
}

/* ========= حذف المنتج ========= */
async function deleteProduct(id){
    if(!confirm("حذف المنتج؟")) return;

    await sb.from("products").delete().eq("id", id);
    loadProducts();
}

/* ========= رفع صورة ========= */
async function uploadImage(file){
    const fileName = Date.now()+"_"+file.name;

    let { data, error } = await sb.storage
        .from("product-images")
        .upload(fileName, file);

    if(error){
        alert("خطأ رفع الصورة");
        return null;
    }

    const { data: urlData } = sb.storage
        .from("product-images")
        .getPublicUrl(fileName);

    return urlData.publicUrl;
}

/* ========= حفظ / تعديل المنتج ========= */
document.getElementById("saveProduct").onclick = async ()=>{
    const id = document.getElementById("editID").value;

    const name = document.getElementById("pName").value;
    const price = Number(document.getElementById("pPrice").value);
    const category = Number(document.getElementById("pCategory").value);
    const file = document.getElementById("pImage").files[0];

    if(!name || !price){
        alert("أدخل البيانات");
        return;
    }

    let imgURL = null;
    if(file){
        imgURL = await uploadImage(file);
    }

    let payload = {
        name,
        price,
        category
    };

    if(imgURL) payload.image = imgURL;

    if(!id){
        await sb.from("products").insert([payload]);
    } else {
        await sb.from("products").update(payload).eq("id", id);
    }

    alert("تم الحفظ بنجاح");
    document.getElementById("editID").value = "";
    loadProducts();
};

/* ========= إضافة قسم ========= */
document.getElementById("addCategory").onclick = async ()=>{
    const name = document.getElementById("catName").value.trim();
    if(!name) return;

    await sb.from("categories").insert([{name}]);
    document.getElementById("catName").value = "";
    loadCategories();
};

/* ========= Init ========= */
loadCategories();
loadProducts();
</script>

</body>
</html>