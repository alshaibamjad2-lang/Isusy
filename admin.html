<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€“ Ø§Ù„Ù…Ù†ÙŠÙˆ</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
    background:#000;
    color:#fff;
    font-family:"Cairo", sans-serif;
    padding:20px;
}

h1{
    color:#c9a45a;
    text-align:center;
    margin-bottom:25px;
}

.box{
    background:#111;
    padding:20px;
    border-radius:12px;
    margin-bottom:20px;
    border:1px solid #333;
}

input, select{
    width:100%;
    padding:10px;
    margin-top:8px;
    border-radius:8px;
    border:1px solid #444;
    background:#000;
    color:#fff;
}

button{
    padding:10px 15px;
    border:none;
    border-radius:8px;
    background:#c9a45a;
    font-weight:bold;
    cursor:pointer;
    margin-top:10px;
}

.product{
    background:#1b1b1b;
    padding:12px;
    border-radius:10px;
    margin-top:12px;
    border:1px solid #333;
}

.product img{
    width:100px;
    border-radius:6px;
    cursor:pointer;
}

.btn{
    padding:6px 10px;
    border-radius:6px;
    font-size:13px;
    cursor:pointer;
}

.edit{ background:#0077ff; color:#fff; }
.del{ background:#b30000; color:#fff; }

#imgPreviewPopup{
    position:fixed;
    top:0;left:0;
    width:100%;height:100%;
    background:rgba(0,0,0,.85);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
}
#imgPreviewPopup img{
    width:80%;
    border-radius:10px;
}
</style>
</head>

<body>

<h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€“ Ø§Ù„Ù…Ù†ÙŠÙˆ</h1>

<!-- ==== Ø§Ù„Ø¨Ø­Ø« ==== -->
<div class="box">
    <h2>ğŸ” Ø¨Ø­Ø«</h2>
    <input id="searchBox" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬...">
    <div id="searchResults"></div>
</div>

<!-- ==== Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ==== -->
<div class="box">
    <h2>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>

    <input id="catName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…">
    <button onclick="addCategory()">Ø¥Ø¶Ø§ÙØ©</button>

    <div id="catList"></div>
</div>

<!-- ==== Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬ ==== -->
<div class="box">
    <h2>ğŸ” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>

    <select id="catSelect"></select>
    <input id="prodName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
    <input id="prodPrice" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±">

    <label>Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)</label>
    <input type="file" id="prodImg" accept="image/*">
    <img id="preview" style="max-width:150px;display:none;margin-top:10px;border-radius:6px;">

    <button onclick="saveProduct()">ğŸ’¾ Ø­ÙØ¸</button>
</div>

<!-- ==== Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ==== -->
<div class="box">
    <h2>ğŸ“¦ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
    <div id="productsList"></div>
</div>

<!-- ==== Popup ==== -->
<div id="imgPreviewPopup" onclick="this.style.display='none'">
    <img src="">
</div>

<script>
/* ===== Supabase ===== */
const sb = supabase.createClient(
 "https://ztwbgqkxmdhpzqhnefty.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0d2JncWt4bWRocHpxaG5lZnR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMTQwMDEsImV4cCI6MjA3OTU5MDAwMX0.6W_V9v5VxQpPfv65Ygc51-m7G1Z8sl8fx1B8bWyA6Xg"
);

let editID = null;

/* ===== Loading ===== */
loadCategories();
loadProducts();

/* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ===== */
async function loadCategories(){
    const {data} = await sb.from("categories").select("*").order("id",{ascending:false});

    let catList = document.getElementById("catList");
    let catSelect = document.getElementById("catSelect");

    catList.innerHTML = "";
    catSelect.innerHTML = "<option value=''>Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>";

    data.forEach(c=>{
        catSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;

        catList.innerHTML += `
            <div class="product">
                <strong>${c.name}</strong>
                <button class="btn edit" onclick="editCategory(${c.id},'${c.name}')">ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn del" onclick="deleteCategory(${c.id})">Ø­Ø°Ù</button>
            </div>
        `;
    });
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… ===== */
async function addCategory(){
    const name = catName.value.trim();
    if(!name) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…");

    await sb.from("categories").insert([{name}]);
    catName.value = "";
    loadCategories();
}

/* ===== ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø³Ù… ===== */
async function editCategory(id, oldName){
    const newName = prompt("Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯:", oldName);
    if(!newName) return;
    await sb.from("categories").update({name:newName}).eq("id",id);
    loadCategories();
}

/* ===== Ø­Ø°Ù Ù‚Ø³Ù… ===== */
async function deleteCategory(id){
    if(!confirm("Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…ØŸ")) return;
    await sb.from("products").delete().eq("category_id",id);
    await sb.from("categories").delete().eq("id",id);
    loadCategories();
    loadProducts();
}

/* ===== Ø±ÙØ¹ ØµÙˆØ±Ø© ===== */
async function uploadImg(file){
    let name = Date.now()+"-"+file.name;
    let {data,error} = await sb.storage.from("menu-images").upload(name,file);
    if(error) return null;
    return sb.storage.from("menu-images").getPublicUrl(name).data.publicUrl;
}

/* ===== Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ ===== */
async function saveProduct(){
    const name = prodName.value.trim();
    const price = Number(prodPrice.value);
    const cat = Number(catSelect.value);
    const file = prodImg.files[0];

    if(!name || !price || !cat) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„");

    let imgURL = null;
    if(file) imgURL = await uploadImg(file);

    if(editID){
        // === ØªØ­Ø¯ÙŠØ« ===
        let payload = {
            name,
            price,
            category_id: cat
        };

        if(imgURL) payload.image = imgURL;

        let {error} = await sb.from("products").update(payload).eq("id",editID);

        if(error){
            console.log(error);
            return alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬");
        }

        alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ”");
        editID = null;
    } 
    else {
        // === Ø¥Ø¶Ø§ÙØ© ===
        if(!imgURL) return alert("Ø§Ø®ØªØ± ØµÙˆØ±Ø©");

        await sb.from("products").insert([{
            name, price, image: imgURL, category_id: cat
        }]);

        alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ”");
    }

    resetForm();
    loadProducts();
}

/* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ===== */
async function loadProducts(){
    const {data} = await sb.from("products").select("*").order("id",{ascending:false});
    const list = document.getElementById("productsList");

    list.innerHTML = "";

    data.forEach(p=>{
        list.innerHTML += `
            <div class="product">
                <strong>${p.name}</strong> â€” ${p.price} Ø±.Ø³<br>
                <img src="${p.image}" onclick="showImg('${p.image}')">
                <br>
                <button class="btn edit" onclick='startEdit(${p.id},"${p.name}",${p.price},${p.category_id},"${p.image}")'>ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn del" onclick="deleteProduct(${p.id})">Ø­Ø°Ù</button>
            </div>
        `;
    });
}

/* ===== Popup ===== */
function showImg(src){
    imgPreviewPopup.querySelector("img").src = src;
    imgPreviewPopup.style.display = "flex";
}

/* ===== ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ===== */
function startEdit(id,name,price,cat,img){
    editID = id;
    prodName.value = name;
    prodPrice.value = price;
    catSelect.value = cat;
    preview.src = img;
    preview.style.display = "block";
}

/* ===== Ø­Ø°Ù Ù…Ù†ØªØ¬ ===== */
async function deleteProduct(id){
    if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) return;
    await sb.from("products").delete().eq("id",id);
    loadProducts();
}

/* ===== Ø§Ù„Ø¨Ø­Ø« ===== */
searchBox.oninput = async ()=>{
    const q = searchBox.value.trim();
    const box = searchResults;

    if(q.length < 2){ box.innerHTML = ""; return; }

    const {data} = await sb.from("products")
        .select("*")
        .ilike("name", `%${q}%`);

    box.innerHTML = "";

    data.forEach(p=>{
        box.innerHTML += `
            <div class="product">
                <strong>${p.name}</strong> â€” ${p.price} Ø±.Ø³<br>
                <img src="${p.image}">
                <button class="btn edit" onclick='startEdit(${p.id},"${p.name}",${p.price},${p.category_id},"${p.image}")'>ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn del" onclick="deleteProduct(${p.id})">Ø­Ø°Ù</button>
            </div>
        `;
    });
}

/* ===== Reset ===== */
function resetForm(){
    prodName.value="";
    prodPrice.value="";
    catSelect.value="";
    prodImg.value="";
    preview.style.display="none";
}
</script>

</body>
</html>